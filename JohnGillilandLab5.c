#define NES_MIRRORING 1


#include "neslib.h"
#include "vrambuf.h"
#include "bcd.h"
#include "vrambuf.c"
#include <nes.h>
#include <stdlib.h>
#include <string.h>
#include "apu.h"//#link "apu.c"
//#include "music.h"

#define TILE 0xc4
#define ATTR 0
// link the pattern table into CHR ROM
//#link "chr_generic.s"

const int note_table[64] = {
2152,4063,3835,3620,3417,3225,3044,2873,2712,2560,2416,2280,2152,2032,1918,1810,
1708,1612,1522,1437,1356,1280,1208,1140,1076,1016,959,905,854,806,761,718,678,640,
604,570,538,508,479,452,427,403,380,359,339,320,302,285,269,254,240,226,214,202,190,
180,169,160,151,143,135,127,120,113,};

const unsigned char map1[226]={
0x01,0x80,0x01,0x07,0x00,0x01,0x12,0x80,0x01,0x0c,0x00,0x01,0x13,0x80,0x01,0x09,
0x00,0x01,0x13,0x82,0x00,0x00,0x80,0x01,0x07,0x00,0x01,0x18,0x80,0x01,0x04,0x00,
0x00,0x82,0x00,0x01,0x18,0x80,0x01,0x02,0x00,0x01,0x0f,0x82,0x00,0x01,0x40,0x85,
0x00,0x01,0x17,0x82,0x00,0x01,0x36,0x82,0x00,0x01,0x13,0x83,0x01,0x06,0x00,0x01,
0x0b,0x83,0x83,0x00,0x01,0x07,0x83,0x01,0x03,0x00,0x01,0x04,0x83,0x01,0x05,0x85,
0x00,0x01,0x03,0x85,0x83,0x83,0x00,0x01,0x16,0x83,0x01,0x07,0x00,0x01,0x0e,0x82,
0x00,0x01,0x35,0x82,0x00,0x01,0x23,0x82,0x00,0x01,0x2d,0x82,0x00,0x01,0x05,0x82,
0x00,0x01,0x50,0x80,0x00,0x01,0x10,0x82,0x00,0x01,0x0c,0x80,0x80,0x00,0x01,0x1d,
0x80,0x01,0x02,0x00,0x01,0x1c,0xb2,0x01,0x20,0x54,0x55,0x52,0x4e,0x00,0x94,0x91,
0x00,0x41,0x54,0x4b,0x5b,0x00,0x00,0x5d,0x5b,0x00,0x00,0x5d,0x41,0x54,0x4b,0x00,
0x94,0x91,0x00,0x01,0x04,0xb2,0xb2,0x00,0x01,0x04,0x93,0x92,0x00,0x48,0x49,0x54,
0x5b,0x00,0x00,0x5d,0x5b,0x00,0x00,0x5d,0x48,0x49,0x54,0x00,0x93,0x92,0x00,0x01,
0x04,0xb2,0xb2,0x00,0x01,0x07,0x43,0x52,0x54,0x5b,0x00,0x00,0x5d,0x5b,0x00,0x00,
0x5d,0x43,0x52,0x54,0x00,0x01,0x07,0xb2,0xb2,0x00,0x01,0x1d,0xb2,0x01,0x1f,0xb2,
0x01,0x00
};

const unsigned int map1data[226] = {
  3,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,
  3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,3,3,
  3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,
  3,3,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
  3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
};







const unsigned char map2[328]={
0x01,0x84,0x01,0x06,0x00,0x01,0x0f,0x80,0x01,0x08,0x84,0x54,0x55,0x52,0x4e,0x00,
0x84,0x00,0x01,0x0f,0x80,0x01,0x08,0x84,0x01,0x06,0x00,0x01,0x11,0x80,0x01,0x06,
0x00,0x01,0x18,0x82,0x80,0x01,0x05,0x00,0x01,0x07,0x82,0x00,0x01,0x06,0x82,0x00,
0x01,0x09,0x80,0x01,0x04,0x00,0x01,0x1b,0x85,0x80,0x01,0x02,0x00,0x01,0x0b,0x82,
0x00,0x01,0x06,0x82,0x00,0x01,0x08,0x80,0x80,0x00,0x01,0x1d,0x82,0x80,0x00,0x01,
0x21,0x82,0x00,0x01,0x02,0x82,0x00,0x01,0x04,0x83,0x01,0x07,0x00,0x01,0x05,0x82,
0x00,0x01,0x0e,0x83,0x01,0x0b,0x00,0x01,0x12,0x83,0x01,0x0d,0x00,0x01,0x10,0x83,
0x01,0x0f,0x00,0x01,0x0f,0x83,0x01,0x06,0x00,0x00,0x82,0x83,0x01,0x06,0x00,0x01,
0x06,0x83,0x01,0x0d,0x00,0x01,0x04,0x83,0x01,0x05,0x00,0x01,0x03,0x82,0x00,0x01,
0x09,0x83,0x01,0x05,0x82,0x00,0x85,0x00,0x01,0x02,0x83,0x01,0x05,0x00,0x01,0x0d,
0x83,0x01,0x05,0x00,0x01,0x05,0x82,0x83,0x01,0x04,0x00,0x01,0x0e,0x83,0x01,0x05,
0x00,0x01,0x04,0x83,0x01,0x05,0x00,0x01,0x0f,0x83,0x01,0x05,0xc5,0x00,0x82,0x83,
0x01,0x05,0x00,0x01,0x11,0x83,0x01,0x04,0xc5,0x83,0x01,0x07,0x00,0x01,0x09,0x82,
0x00,0x01,0x06,0x83,0x01,0x04,0xc5,0x83,0x01,0x06,0x00,0x01,0x13,0x83,0x01,0x03,
0xc5,0x83,0x01,0x05,0x00,0x01,0x03,0x82,0x00,0x01,0x02,0x82,0x00,0x01,0x0e,0x83,
0xc5,0x83,0x01,0x02,0x00,0x01,0x08,0x82,0x01,0x02,0x00,0x01,0x06,0x82,0x00,0x01,
0x06,0x85,0x00,0x85,0x00,0x01,0x08,0x82,0x01,0x04,0x00,0x01,0x19,0x82,0x01,0x04,
0x80,0x00,0x01,0x19,0x82,0x01,0x03,0x80,0x80,0x00,0x01,0x18,0x82,0x01,0x03,0x80,
0x01,0x02,0x00,0x01,0x02,0x82,0x00,0x01,0x13,0x82,0x01,0x03,0x80,0x01,0x03,0x00,
0x01,0x0c,0x82,0x00,0x01,0x09,0x82,0x01,0x02,0x80,0x01,0x04,0x00,0x01,0x16,0x82,
0x01,0x02,0x80,0x01,0x04,0x85,0x01,0x00
};

const int note_table_41[64] = {
4318, 4076, 3847, 3631, 3427, 3235, 3053, 2882, 2720, 2567, 2423, 2287, 2159, 2037, 1923, 1815, 1713, 1617, 1526, 1440, 1360, 1283, 1211, 1143, 1079, 1018, 961, 907, 856, 808, 763, 720, 679, 641, 605, 571, 539, 509, 480, 453, 428, 403, 381, 359, 339, 320, 302, 285, 269, 254, 240, 226, 213, 201, 190, 179, 169, 160, 151, 142, 134, 126, 119, 113, };

// Namespace(bias=1.0, freq=111860.8, length=64, maxbits=13, upper=49)
// 440.5 1.79281159771 49
const int note_table_49[64] = {
4304, 4062, 3834, 3619, 3416, 3224, 3043, 2872, 2711, 2559, 2415, 2279, 2151, 2031, 1917, 1809, 1707, 1611, 1521, 1436, 1355, 1279, 1207, 1139, 1075, 1015, 958, 904, 853, 805, 760, 717, 677, 639, 603, 569, 537, 507, 478, 451, 426, 402, 379, 358, 338, 319, 301, 284, 268, 253, 239, 225, 213, 201, 189, 179, 168, 159, 150, 142, 134, 126, 119, 112, };

// Namespace(bias=1.0, freq=111860.8, length=64, maxbits=12, upper=63)
// 443.6 14.2328382554 63
const int note_table_63[64] = {
2137, 4034, 3807, 3593, 3392, 3201, 3022, 2852, 2692, 2541, 2398, 2263, 2136, 2016, 1903, 1796, 1695, 1600, 1510, 1425, 1345, 1270, 1199, 1131, 1068, 1008, 951, 898, 847, 800, 755, 712, 672, 634, 599, 565, 533, 503, 475, 448, 423, 399, 377, 356, 336, 317, 299, 282, 266, 251, 237, 224, 211, 199, 188, 177, 167, 158, 149, 141, 133, 125, 118, 111, };

// Namespace(bias=-1.0, freq=55930.4, length=64, maxbits=12, upper=53)
// 443.7 8.47550713772 53
const int note_table_tri[64] = {
2138, 2018, 1905, 1798, 1697, 1602, 1512, 1427, 1347, 1272, 1200, 1133, 1069, 1009, 953, 899, 849, 801, 756, 714, 674, 636, 601, 567, 535, 505, 477, 450, 425, 401, 379, 358, 338, 319, 301, 284, 268, 253, 239, 226, 213, 201, 190, 179, 169, 160, 151, 142, 135, 127, 120, 113, 107, 101, 95, 90, 85, 80, 76, 72, 68, 64, 60, 57, };

#define NOTE_TABLE note_table_49
#define BASS_NOTE 36

byte music_index = 0;
byte cur_duration = 0;

const byte music1[]; // music data -- see end of file
const byte* music_ptr = music1;

byte next_music_byte() {
  return *music_ptr++;
}

void play_music() {
  static byte chs = 0;
  if (music_ptr) {
    // run out duration timer yet?
    while (cur_duration == 0) {
      // fetch next byte in score
      byte note = next_music_byte();
      // is this a note?
      if ((note & 0x80) == 0) {
        // pulse plays higher notes, triangle for lower if it's free
        if (note >= BASS_NOTE || (chs & 4)) {
          int period = NOTE_TABLE[note & 63];
          // see which pulse generator is free
          if (!(chs & 1)) {
            APU_PULSE_DECAY(0, period, DUTY_25, 2, 10);
            chs |= 1;
          } else if (!(chs & 2)) {
            APU_PULSE_DECAY(1, period, DUTY_25, 2, 10);
            chs |= 2;
          }
        } else {
          int period = note_table_tri[note & 63];
          APU_TRIANGLE_LENGTH(period, 15);
          chs |= 4;
        }
      } else {
        // end of score marker
        if (note == 0xff)
          music_ptr = NULL;
        // set duration until next note
        cur_duration = note & 63;
        // reset channel used mask
        chs = 0;
      }
    }
    cur_duration--;
  }
}

void start_music(const byte* music) {
  music_ptr = music;
  cur_duration = 0;
}
const byte music1[] = {
0x2a,0x1e,0x95,0x33,0x27,0x9f,0x31,0x25,0x8a,0x2f,0x23,0x8b,0x2e,0x22,0x89,0x2c,0x20,0x8b,0x2a,0x1e,0x95,0x28,0x1c,0x8a,0x27,0x1b,0x95,0x25,0x19,0x8b,0x23,0x17,0x89,0x22,0x12,0x8b,0x23,0x8a,0x25,0x8b,0x27,0x89,0x28,0x1e,0x8c,0x2a,0x1c,0x89,0x2c,0x1b,0x8c,0x2e,0x19,0x89,0x2f,0x17,0x95,0x27,0x23,0x1e,0x95,0x12,0x95,0x23,0x1e,0x27,0x95,0x2f,0x33,0x17,0x95,0x2f,0x33,0x27,0x94,0x12,0x95,0x33,0x36,0x23,0x95,0x38,0x32,0x17,0x8b,0x33,0x36,0x89,0x1e,0x27,0x23,0x8b,0x38,0x32,0x8a,0x33,0x36,0x12,0x8b,0x32,0x38,0x89,0x36,0x33,0x27,0x95,0x3d,0x37,0x10,0x8b,0x3b,0x38,0x8a,0x20,0x23,0x28,0x8b,0x37,0x3d,0x89,0x38,0x3b,0x10,0x8b,0x37,0x3d,0x8a,0x3b,0x38,0x28,0x8b,0x36,0x33,0x8a,0x17,0x95,0x2a,0x1e,0x23,0x8b,0x2c,0x89,0x2e,0x12,0x8b,0x2f,0x8a,0x31,0x27,0x23,0x8b,0x32,0x89,0x2f,0x33,0x17,0x95,0x33,0x2f,0x1e,0x95,0x12,0x94,0x36,0x33,0x1e,0x95,0x32,0x38,0x17,0x8b,0x36,0x33,0x89,0x23,0x1e,0x27,0x8b,0x38,0x32,0x8a,0x33,0x36,0x18,0x8b,0x33,0x36,0x8a,0x33,0x36,0x2a,0x95,0x36,0x19,0x8b,0x31,0x2e,0x89,0x25,0x22,0x2a,0x8b,0x36,0x8a,0x2f,0x35,0x19,0x8b,0x36,0x89,0x38,0x2f,0x29,0x95,0x2e,0x36,0x1e,0x95,0x1c,0x28,0x95,0x27,0x1b,0x8b,0x2a,0x8a,0x2e,0x25,0x19,0x8b,0x34,0x89,0x33,0x2f,0x23,0x95,0x33,0x2f,0x1e,0x95,0x12,0x94,0x33,0x36,0x23,0x95,0x32,0x38,0x17,0x8b,0x33,0x36,0x8a,0x23,0x27,0x1e,0x8b,0x38,0x32,0x89,0x36,0x33,0x12,0x8b,0x32,0x38,0x8a,0x33,0x36,0x1e,0x94,0x37,0x3d,0x10,0x8b,0x3b,0x38,0x8a,0x23,0x28,0x20,0x8b,0x3d,0x37,0x89,0x3b,0x38,0x1c,0x8b,0x38,0x3b,0x8a,0x3a,0x3d,0x38,0x8b,0x3f,0x37,0x3a,0x89,0x27,0x1b,0x8b,0x33,0x8a,0x37,0x22,0x16,0x8b,0x3a,0x8a,0x3f,0x0f,0x1b,0x95,0x3a,0x8b,0x3b,0x8a,0x3d,0x37,0x1c,0x8b,0x3b,0x38,0x89,0x23,0x28,0x20,0x8b,0x3d,0x37,0x8a,0x38,0x3b,0x10,0x8b,0x3d,0x37,0x89,0x38,0x3b,0x20,0x8b,0x36,0x33,0x8a,0x17,0x23,0x8b,0x38,0x34,0x8a,0x33,0x36,0x1e,0x8b,0x31,0x34,0x8a,0x2f,0x33,0x17,0x8b,0x36,0x33,0x8a,0x23,0x27,0x1e,0x8b,0x33,0x36,0x8a,0x36,0x30,0x12,0x8a,0x34,0x31,0x8a,0x1e,0x28,0x22,0x8b,0x30,0x36,0x89,0x34,0x31,0x12,0x8b,0x2e,0x28,0x33,0x8a,0x31,0x28,0x2e,0x95,0x27,0x2f,0x1e,0x95,0x12,0x95,0x14,0x94,0x16,0x95,0x2f,0x33,0x17,0x95,0x2f,0x33,0x27,0x94,0x12,0x95,0x36,0x33,0x23,0x95,0x32,0x38,0x17,0x8a,0x33,0x36,0x8a,0x23,0x27,0x1e,0x8b,0x32,0x38,0x8a,0x33,0x36,0x12,0x8b,0x38,0x32,0x8a,0x36,0x33,0x27,0x95,0x3d,0x37,0x10,0x8a,0x3b,0x38,0x8a,0x23,0x28,0x20,0x8b,0x37,0x3d,0x89,0x3b,0x38,0x10,0x8b,0x37,0x3d,0x8a,0x38,0x3b,0x23,0x8b,0x36,0x33,0x8a,0x17,0x95,0x2a,0x1e,0x23,0x8b,0x2c,0x8a,0x2e,0x12,0x8b,0x2f,0x89,0x31,0x23,0x1e,0x8b,0x32,0x8a,0x33,0x2f,0x17,0x95,0x2f,0x33,0x1e,0x94,0x12,0x95,0x36,0x33,0x27,0x95,0x38,0x32,0x17,0x8a,0x36,0x33,0x8a,0x23,0x1e,0x27,0x8b,0x38,0x32,0x89,0x33,0x36,0x18,0x8c,0x36,0x33,0x89,0x33,0x36,0x21,0x95,0x36,0x19,0x8b,0x2e,0x31,0x8a,0x25,0x2a,0x22,0x8b,0x36,0x89,0x35,0x2f,0x19,0x8b,0x36,0x8a,0x2f,0x38,0x25,0x94,0x36,0x2e,0x2a,0x95,0x1c,0x28,0x95,0x27,0x1b,0x8c,0x2a,0x89,0x2e,0x25,0x19,0x8b,0x34,0x8a,0x33,0x2f,0x23,0x95,0x2f,0x33,0x1e,0x94,0x12,0x95,0x33,0x36,0x23,0x95,0x32,0x38,0x17,0x8a,0x33,0x36,0x8a,0x23,0x1e,0x27,0x8b,0x32,0x38,0x89,0x36,0x33,0x12,0x8c,0x32,0x38,0x89,0x33,0x36,0x1e,0x95,0x37,0x3d,0x10,0x8b,0x3b,0x38,0x8a,0x23,0x20,0x28,0x8a,0x3d,0x37,0x8a,0x38,0x3b,0x1c,0x8b,0x3b,0x38,0x8a,0x3d,0x38,0x3a,0x8b,0x3a,0x3f,0x37,0x89,0x27,0x1b,0x8b,0x33,0x8a,0x37,0x22,0x16,0x8b,0x3a,0x8a,0x3f,0x0f,0x1b,0x95,0x3a,0x8b,0x3b,0x8a,0x3d,0x37,0x1c,0x8b,0x3b,0x38,0x8a,0x20,0x28,0x23,0x8b,0x3d,0x37,0x89,0x38,0x3b,0x10,0x8b,0x3d,0x37,0x8a,0x38,0x3b,0x20,0x8b,0x33,0x36,0x89,0x17,0x23,0x8b,0x38,0x34,0x8a,0x36,0x33,0x23,0x8b,0x34,0x31,0x89,0x2f,0x33,0x17,0x8c,0x36,0x33,0x89,0x1e,0x27,0x23,0x8c,0x33,0x36,0x89,0x36,0x30,0x12,0x8b,0x34,0x31,0x8a,0x1e,0x28,0x22,0x8a,0x30,0x36,0x8a,0x34,0x31,0x1e,0x8b,0x28,0x2e,0x33,0x89,0x28,0x31,0x2e,0x95,0x27,0x2f,0x17,0x95,0x12,0x1e,0x95,0x3b,0x36,0x33,0x96,0x2a,0x8b,0x2b,0x8a,0x2c,0x1e,0x12,0x8b,0x2d,0x89,0x2e,0x28,0x1e,0x8b,0x2e,0x31,0x8a,0x16,0x22,0x8b,0x36,0x89,0x34,0x1e,0x22,0x8b,0x31,0x8a,0x2c,0x25,0x19,0x8b,0x2d,0x89,0x2e,0x28,0x25,0x8b,0x33,0x2e,0x8a,0x25,0x19,0x8c,0x31,0x89,0x2c,0x1a,0x26,0x8b,0x2e,0x8a,0x2f,0x1b,0x27,0x8b,0x2a,0x89,0x2c,0x23,0x1e,0x8b,0x2e,0x8a,0x2f,0x12,0x1e,0x8b,0x30,0x89,0x31,0x27,0x23,0x8b,0x32,0x8a,0x33,0x17,0x23,0x8b,0x32,0x8a,0x33,0x1e,0x23,0x8b,0x38,0x33,0x8a,0x1e,0x12,0x8b,0x36,0x8a,0x31,0x1e,0x23,0x8b,0x33,0x89,0x34,0x25,0x19,0x8b,0x3d,0x89,0x1e,0x28,0x22,0x8b,0x33,0x89,0x34,0x12,0x1e,0x8b,0x3d,0x8a,0x1e,0x22,0x28,0x8a,0x33,0x8a,0x34,0x19,0x25,0x8b,0x3d,0x89,0x28,0x1e,0x22,0x8b,0x3b,0x89,0x3a,0x1e,0x12,0x8b,0x38,0x8a,0x36,0x22,0x16,0x8b,0x34,0x8a,0x33,0x23,0x17,0x8b,0x3b,0x8a,0x1e,0x23,0x27,0x8a,0x32,0x8a,0x33,0x12,0x1e,0x8b,0x3b,0x89,0x27,0x23,0x1e,0x8b,0x32,0x89,0x33,0x23,0x17,0x8b,0x3b,0x89,0x1e,0x23,0x27,0x8b,0x38,0x8a,0x36,0x12,0x1e,0x8b,0x33,0x89,0x31,0x1e,0x27,0x8b,0x2f,0x8a,0x2e,0x20,0x14,0x8b,0x2f,0x8a,0x30,0x2a,0x24,0x8b,0x30,0x38,0x8a,0x24,0x18,0x8b,0x36,0x89,0x33,0x24,0x20,0x8b,0x30,0x8a,0x2e,0x27,0x1b,0x8b,0x2f,0x89,0x30,0x24,0x2a,0x8b,0x30,0x38,0x8a,0x20,0x14,0x8b,0x33,0x36,0x8a,0x38,0x30,0x24,0x8b,0x33,0x36,0x89,0x34,0x31,0x19,0x8b,0x30,0x33,0x89,0x31,0x34,0x25,0x8b,0x2c,0x89,0x1c,0x8b,0x30,0x8a,0x31,0x20,0x28,0x8a,0x34,0x8a,0x38,0x19,0x8b,0x33,0x89,0x34,0x25,0x20,0x8b,0x31,0x8a,0x25,0x20,0x1c,0x8b,0x2c,0x8a,0x28,0x8b,0x25,0x8a,0x26,0x1d,0x8a,0x29,0x20,0x8a,0x2c,0x23,0x8b,0x2f,0x26,0x89,0x32,0x29,0x8b,0x32,0x29,0x94,0x32,0x29,0x94,0x35,0x2c,0x8a,0x38,0x2f,0x8a,0x3b,0x32,0x8a,0x35,0x3e,0xa8,0x2f,0x3f,0x36,0x8b,0x3b,0x8a,0x36,0x8b,0x33,0x94,0x2f,0x8a,0x27,0x8b,0x2a,0x89,0x2a,0x2e,0x28,0x8b,0x31,0x2a,0x2e,0x8a,0x1e,0x12,0x8b,0x2f,0x2a,0x27,0x8a,0x17,0x23,0x95,0x2a,0x8b,0x2b,0x8a,0x2c,0x1e,0x12,0x8a,0x2d,0x8a,0x2e,0x25,0x1e,0x8b,0x31,0x2e,0x89,0x22,0x16,0x8b,0x36,0x8a,0x34,0x1e,0x22,0x8a,0x31,0x8a,0x2c,0x25,0x19,0x8b,0x2d,0x89,0x2e,0x28,0x25,0x8b,0x33,0x2e,0x8a,0x19,0x25,0x8a,0x31,0x8a,0x2c,0x1a,0x26,0x8b,0x2e,0x89,0x2f,0x27,0x1b,0x8b,0x2a,0x89,0x2c,0x23,0x1e,0x8b,0x2e,0x8a,0x2f,0x1e,0x12,0x8b,0x30,0x89,0x31,0x27,0x23,0x8b,0x32,0x8a,0x33,0x17,0x23,0x8b,0x32,0x8a,0x33,0x1e,0x23,0x8b,0x33,0x38,0x8a,0x12,0x1e,0x8b,0x36,0x8a,0x31,0x27,0x1e,0x8b,0x33,0x89,0x34,0x25,0x19,0x8b,0x3d,0x89,0x28,0x1e,0x22,0x8b,0x33,0x8a,0x34,0x1e,0x12,0x8b,0x3d,0x89,0x1e,0x22,0x28,0x8b,0x33,0x89,0x34,0x19,0x25,0x8b,0x3d,0x8a,0x22,0x1e,0x28,0x8b,0x3b,0x89,0x3a,0x12,0x1e,0x8b,0x38,0x89,0x36,0x22,0x16,0x8b,0x34,0x8a,0x33,0x23,0x17,0x8b,0x3b,0x8a,0x1e,0x27,0x23,0x8b,0x32,0x8a,0x33,0x1e,0x12,0x8a,0x3b,0x8a,0x23,0x1e,0x27,0x8b,0x32,0x89,0x33,0x23,0x17,0x8b,0x3b,0x8a,0x27,0x1e,0x23,0x8a,0x38,0x8a,0x36,0x12,0x1e,0x8b,0x33,0x8a,0x31,0x1e,0x23,0x8b,0x2f,0x89,0x2e,0x14,0x20,0x8b,0x2f,0x8a,0x30,0x24,0x20,0x8b,0x38,0x30,0x89,0x18,0x24,0x8c,0x36,0x8a,0x33,0x24,0x20,0x8a,0x30,0x8a,0x2e,0x27,0x1b,0x8b,0x2f,0x89,0x30,0x24,0x20,0x8b,0x38,0x30,0x8a,0x14,0x20,0x8b,0x36,0x33,0x8a,0x30,0x38,0x20,0x8b,0x36,0x33,0x8a,0x31,0x34,0x19,0x8b,0x33,0x30,0x89,0x34,0x31,0x25,0x8b,0x2c,0x8a,0x1c,0x8a,0x30,0x8a,0x31,0x28,0x20,0x8b,0x34,0x89,0x38,0x19,0x8b,0x33,0x8a,0x34,0x25,0x20,0x8b,0x31,0x8a,0x25,0x20,0x1c,0x8b,0x2c,0x89,0x28,0x8b,0x25,0x8a,0x26,0x1d,0x8b,0x29,0x20,0x89,0x2c,0x23,0x8b,0x2f,0x26,0x8a,0x32,0x29,0x8a,0x32,0x29,0x95,0x32,0x29,0x94,0x35,0x2c,0x8a,0x38,0x2f,0x8b,0x3b,0x32,0x89,0x3e,0x35,0xa9,0x36,0x3f,0x2f,0x8b,0x3b,0x8a,0x36,0x8b,0x33,0x95,0x2f,0x89,0x27,0x8b,0x2a,0x89,0x28,0x31,0x2a,0x8b,0x2e,0x31,0x28,0x8a,0x12,0x1e,0x8b,0x27,0x2a,0x2f,0x8a,0x17,0x23,0x95,0x2a,0x94,0x33,0x2f,0x17,0x94,0x2f,0x33,0x1e,0x95,0x12,0x94,0x33,0x36,0x23,0x95,0x38,0x32,0x17,0x8a,0x33,0x36,0x8a,0x27,0x1e,0x23,0x8b,0x32,0x38,0x8a,0x33,0x36,0x12,0x8b,0x32,0x38,0x89,0x33,0x36,0x27,0x95,0x3d,0x37,0x10,0x8b,0x38,0x3b,0x8a,0x28,0x20,0x23,0x8b,0x3d,0x37,0x89,0x3b,0x38,0x10,0x8b,0x3d,0x37,0x8a,0x38,0x3b,0x23,0x8b,0x36,0x33,0x8a,0x17,0x95,0x2a,0x1e,0x23,0x8b,0x2c,0x89,0x2e,0x12,0x8b,0x2f,0x8a,0x31,0x23,0x1e,0x8b,0x32,0x89,0x33,0x2f,0x17,0x94,0x2f,0x33,0x1e,0x95,0x12,0x94,0x33,0x36,0x27,0x95,0x38,0x32,0x17,0x8b,0x36,0x33,0x8a,0x23,0x27,0x1e,0x8b,0x32,0x38,0x8a,0x33,0x36,0x18,0x8b,0x36,0x33,0x8a,0x33,0x36,0x2a,0x95,0x36,0x19,0x8b,0x31,0x2e,0x89,0x22,0x2a,0x25,0x8b,0x36,0x89,0x35,0x2f,0x19,0x8b,0x36,0x8a,0x2f,0x38,0x25,0x95,0x2e,0x36,0x2a,0x95,0x28,0x1c,0x95,0x27,0x1b,0x8b,0x2a,0x8a,0x2e,0x25,0x19,0x8b,0x34,0x89,0x33,0x2f,0x17,0x95,0x2f,0x33,0x23,0x94,0x12,0x95,0x33,0x36,0x1e,0x95,0x38,0x32,0x17,0x8b,0x36,0x33,0x8a,0x23,0x27,0x1e,0x8b,0x32,0x38,0x8a,0x33,0x36,0x12,0x8b,0x38,0x32,0x8a,0x33,0x36,0x1e,0x95,0x3d,0x37,0x10,0x8b,0x3b,0x38,0x89,0x23,0x28,0x20,0x8b,0x37,0x3d,0x8a,0x38,0x3b,0x1c,0x8b,0x38,0x3b,0x89,0x38,0x3d,0x3a,0x8b,0x3f,0x3a,0x37,0x8a,0x1b,0x27,0x8b,0x33,0x8a,0x37,0x22,0x16,0x8b,0x3a,0x8a,0x3f,0x0f,0x1b,0x95,0x3a,0x8b,0x3b,0x89,0x3d,0x37,0x1c,0x8b,0x38,0x3b,0x8a,0x28,0x20,0x23,0x8a,0x3d,0x37,0x8a,0x38,0x3b,0x10,0x8b,0x3d,0x37,0x89,0x3b,0x38,0x20,0x8b,0x33,0x36,0x8a,0x23,0x17,0x8b,0x38,0x34,0x8a,0x33,0x36,0x27,0x8b,0x34,0x31,0x8a,0x33,0x2f,0x23,0x8b,0x36,0x33,0x8a,0x1e,0x23,0x27,0x8b,0x33,0x36,0x8a,0x36,0x30,0x12,0x8b,0x34,0x31,0x89,0x1e,0x28,0x22,0x8b,0x30,0x36,0x89,0x31,0x34,0x1e,0x8b,0x2e,0x28,0x33,0x8a,0x28,0x31,0x2e,0x95,0x2f,0x27,0x17,0x95,0x12,0x1e,0x95,0x36,0x33,0x3b,0xa9,0x34,0x28,0x95,0x34,0x28,0xa0,0x2f,0x23,0x8a,0x34,0x28,0x8b,0x36,0x2a,0x8a,0x38,0x2c,0x94,0x2c,0x38,0xa1,0x2f,0x23,0x89,0x28,0x34,0x8b,0x2c,0x38,0x8a,0x39,0x3b,0x2f,0x8b,0x3f,0x39,0x36,0x94,0x33,0x39,0x3d,0x8a,0x17,0x23,0x8b,0x3b,0x33,0x39,0x89,0x33,0x2f,0x2d,0x95,0x34,0x2c,0x2f,0x95,0x1c,0x10,0x95,0x12,0x1e,0x95,0x2f,0x14,0x20,0x8b,0x30,0x89,0x31,0x21,0x15,0x8b,0x39,0x8a,0x28,0x2d,0x25,0x8b,0x36,0x8a,0x30,0x1e,0x2a,0x8b,0x39,0x89,0x1f,0x2b,0x8b,0x36,0x8a,0x2f,0x2c,0x20,0x8b,0x34,0x8a,0x38,0x23,0x28,0x8b,0x3d,0x89,0x1c,0x28,0x8b,0x3b,0x8a,0x38,0x23,0x28,0x8b,0x34,0x8a,0x33,0x17,0x23,0x8b,0x3b,0x89,0x36,0x2d,0x23,0x8b,0x33,0x8a,0x31,0x1e,0x2a,0x8b,0x33,0x89,0x1f,0x2b,0x8c,0x2f,0x89,0x34,0x20,0x2c,0x8b,0x34,0x8a,0x38,0x28,0x1c,0x8b,0x3b,0x89,0x40,0x23,0x17,0x8b,0x3d,0x8a,0x3b,0x14,0x20,0x8b,0x38,0x8a,0x31,0x15,0x21,0x8b,0x39,0x89,0x28,0x25,0x2d,0x8b,0x36,0x8a,0x30,0x1e,0x2a,0x8b,0x39,0x8a,0x2b,0x1f,0x8b,0x36,0x89,0x2f,0x2c,0x20,0x8b,0x34,0x8a,0x38,0x28,0x2c,0x8b,0x3d,0x8a,0x28,0x1c,0x8b,0x3b,0x89,0x38,0x28,0x2c,0x8b,0x34,0x8a,0x36,0x19,0x25,0x8b,0x38,0x8a,0x36,0x28,0x2e,0x8b,0x34,0x89,0x33,0x12,0x1e,0x8b,0x34,0x8a,0x2a,0x2e,0x28,0x8b,0x31,0x89,0x2f,0x27,0x2a,0x81,0x23,0x94,0x32,0x38,0x1d,0x8b,0x33,0x36,0x1e,0x8a,0x33,0x3b,0x17,0x95,0x2f,0x32,0x20,0x94,0x31,0x15,0x21,0x8b,0x39,0x8a,0x2d,0x28,0x25,0x8b,0x36,0x8a,0x30,0x1e,0x2a,0x8b,0x39,0x8a,0x1f,0x2b,0x8b,0x36,0x89,0x20,0x2c,0x8b,0x2f,0x8a,0x34,0x23,0x2c,0x8b,0x38,0x8a,0x3d,0x28,0x1c,0x8b,0x3b,0x8a,0x38,0x2c,0x28,0x8b,0x34,0x89,0x33,0x17,0x23,0x8b,0x3b,0x8a,0x36,0x23,0x2d,0x8b,0x33,0x8a,0x31,0x1e,0x2a,0x8b,0x33,0x8a,0x2b,0x1f,0x8b,0x2f,0x89,0x2c,0x20,0x8b,0x34,0x8a,0x38,0x28,0x1c,0x8b,0x3b,0x8a,0x38,0x40,0x17,0x8b,0x3d,0x8a,0x32,0x3b,0x20,0x8b,0x38,0x89,0x31,0x15,0x21,0x8b,0x39,0x8a,0x25,0x19,0x8b,0x36,0x8a,0x30,0x2a,0x1e,0x8b,0x39,0x8a,0x21,0x2d,0x8b,0x36,0x89,0x2c,0x20,0x8b,0x2f,0x8a,0x34,0x28,0x1c,0x8b,0x38,0x89,0x3d,0x23,0x17,0x8b,0x3b,0x8a,0x38,0x28,0x1c,0x8b,0x2f,0x89,0x2e,0x19,0x25,0x8b,0x31,0x34,0x8a,0x12,0x1e,0x95,0x2d,0x0b,0x17,0x8b,0x33,0x36,0x95,0x34,0x2c,0x8a,0x1c,0x10,0x96,0x38,0x1c,0x28,0x8b,0x34,0x89,0x36,0x23,0x17,0x8b,0x38,0x8b,0x2f,0x14,0x20,0x8b,0x30,0x89,0x31,0x21,0x15,0x8b,0x39,0x8a,0x28,0x25,0x2d,0x8b,0x36,0x89,0x30,0x2a,0x1e,0x8b,0x39,0x8a,0x1f,0x2b,0x8b,0x36,0x8a,0x2f,0x2c,0x20,0x8b,0x34,0x89,0x38,0x23,0x28,0x8b,0x3d,0x8a,0x1c,0x28,0x8b,0x3b,0x8a,0x38,0x23,0x28,0x8b,0x34,0x89,0x33,0x17,0x23,0x8b,0x3b,0x8a,0x36,0x2d,0x27,0x8b,0x33,0x8a,0x31,0x2a,0x1e,0x8b,0x33,0x89,0x2b,0x1f,0x8b,0x2f,0x8a,0x34,0x20,0x2c,0x8b,0x34,0x8a,0x38,0x28,0x1c,0x8b,0x3b,0x8a,0x40,0x17,0x23,0x8b,0x3d,0x89,0x3b,0x20,0x14,0x8c,0x38,0x89,0x31,0x15,0x21,0x8b,0x39,0x8a,0x2d,0x25,0x28,0x8b,0x36,0x8a,0x30,0x1e,0x2a,0x8b,0x39,0x8a,0x2b,0x1f,0x8b,0x36,0x8a,0x2f,0x2c,0x20,0x8b,0x34,0x8a,0x38,0x23,0x28,0x8b,0x3d,0x8a,0x28,0x1c,0x8b,0x3b,0x89,0x38,0x23,0x28,0x8c,0x34,0x89,0x36,0x19,0x25,0x8b,0x38,0x8a,0x36,0x28,0x2e,0x8b,0x34,0x89,0x33,0x12,0x1e,0x8c,0x34,0x89,0x2e,0x28,0x2a,0x8c,0x31,0x89,0x2f,0x2a,0x27,0x81,0x23,0x94,0x32,0x38,0x1d,0x8c,0x33,0x36,0x1e,0x89,0x3b,0x33,0x17,0x95,0x2f,0x32,0x20,0x95,0x31,0x21,0x15,0x8b,0x39,0x8a,0x2d,0x28,0x25,0x8b,0x36,0x8a,0x30,0x2a,0x1e,0x8b,0x39,0x8a,0x1f,0x2b,0x8b,0x36,0x8a,0x2c,0x20,0x8b,0x2f,0x89,0x34,0x23,0x28,0x8c,0x38,0x89,0x3d,0x28,0x1c,0x8b,0x3b,0x8a,0x38,0x28,0x23,0x8b,0x34,0x8a,0x33,0x17,0x23,0x8b,0x3b,0x8a,0x36,0x2d,0x27,0x8b,0x33,0x8a,0x31,0x2a,0x1e,0x8b,0x33,0x8a,0x2b,0x1f,0x8b,0x2f,0x89,0x2c,0x20,0x8c,0x34,0x89,0x38,0x1c,0x28,0x8b,0x3b,0x8a,0x40,0x38,0x23,0x8b,0x3d,0x8a,0x32,0x3b,0x14,0x8b,0x38,0x8a,0x31,0x15,0x21,0x8b,0x39,0x8a,0x19,0x25,0x8b,0x36,0x8a,0x30,0x2a,0x1e,0x8b,0x39,0x8a,0x2d,0x21,0x8b,0x36,0x8a,0x2c,0x20,0x8b,0x2f,0x89,0x34,0x1c,0x28,0x8b,0x38,0x8a,0x3d,0x23,0x17,0x8b,0x3b,0x89,0x38,0x1c,0x28,0x8c,0x2f,0x89,0x2e,0x19,0x25,0x8b,0x31,0x34,0x8a,0x12,0x1e,0x95,0x2d,0x0b,0x17,0x8c,0x33,0x36,0x95,0x2c,0x34,0x8a,0x1c,0x10,0x95,0x17,0x96,0x10,0x8b,0x3b,0x2f,0x8a,0x31,0x3d,0x8b,0x3e,0x32,0x8a,0x3f,0x33,0x39,0x94,0x3b,0x2f,0x23,0x8b,0x39,0x3d,0x31,0x8a,0x23,0x17,0x95,0x2d,0x23,0x27,0x95,0x3f,0x39,0x33,0x94,0x3b,0x2f,0x2d,0x8b,0x3d,0x39,0x31,0x8a,0x12,0x1e,0x8b,0x3b,0x2f,0x17,0x8a,0x31,0x3d,0x22,0x8b,0x3f,0x33,0x15,0x8a,0x38,0x40,0x34,0x95,0x38,0x3b,0x2f,0x8b,0x31,0x38,0x3d,0x89,0x1c,0x28,0x95,0x28,0x2c,0x23,0x95,0x34,0x40,0x38,0x95,0x38,0x2f,0x3b,0x8b,0x31,0x3d,0x38,0x89,0x28,0x1c,0x95,0x29,0x1d,0x95,0x1e,0x2a,0x95,0x3d,0x27,0x23,0x8b,0x39,0x3b,0x33,0x89,0x23,0x17,0x95,0x2d,0x27,0x23,0x95,0x2a,0x1e,0x95,0x3d,0x23,0x27,0x8b,0x33,0x3b,0x39,0x89,0x23,0x17,0x95,0x27,0x23,0x2d,0x95,0x1c,0x28,0x95,0x3d,0x28,0x2c,0x8b,0x34,0x3b,0x38,0x89,0x23,0x17,0x95,0x28,0x23,0x2c,0x95,0x1c,0x28,0x95,0x3d,0x28,0x23,0x8b,0x38,0x34,0x3b,0x8a,0x20,0x2c,0x8b,0x2f,0x3b,0x89,0x3d,0x31,0x1f,0x8b,0x32,0x3e,0x8a,0x3f,0x39,0x33,0x95,0x3b,0x2f,0x27,0x8b,0x39,0x31,0x3d,0x8a,0x23,0x17,0x94,0x27,0x2d,0x23,0x95,0x33,0x39,0x3f,0x95,0x3b,0x2f,0x27,0x8b,0x3d,0x31,0x39,0x8a,0x12,0x1e,0x8b,0x3b,0x2f,0x23,0x89,0x3d,0x31,0x22,0x8b,0x33,0x3f,0x15,0x8a,0x34,0x40,0x38,0x95,0x3b,0x38,0x2f,0x8b,0x3d,0x31,0x38,0x8a,0x1c,0x28,0x95,0x28,0x23,0x2c,0x95,0x20,0x2c,0x8c,0x34,0x8a,0x38,0x28,0x1c,0x8b,0x3b,0x8a,0x40,0x38,0x23,0x8b,0x3d,0x8a,0x32,0x3b,0x20,0x8b,0x38,0x8a,0x31,0x15,0x21,0x8b,0x39,0x8a,0x19,0x25,0x8b,0x36,0x8a,0x30,0x1e,0x2a,0x8b,0x39,0x8a,0x2d,0x21,0x8b,0x36,0x8a,0x2c,0x20,0x8b,0x2f,0x8a,0x34,0x28,0x1c,0x8b,0x38,0x89,0x3d,0x17,0x23,0x8b,0x3b,0x8a,0x38,0x1c,0x28,0x8b,0x2f,0x8a,0x2e,0x19,0x25,0x8b,0x34,0x31,0x89,0x1e,0x12,0x95,0x2d,0x17,0x0b,0x8b,0x36,0x33,0x95,0x2c,0x34,0x8a,0x10,0x1c,0x95,0x17,0x23,0x96,0x20,0x2c,0x8b,0x2f,0x3b,0x89,0x31,0x3d,0x2b,0x8b,0x32,0x3e,0x89,0x39,0x3f,0x33,0x95,0x2f,0x3b,0x23,0x8b,0x39,0x31,0x3d,0x8a,0x23,0x17,0x95,0x2d,0x23,0x27,0x95,0x3f,0x39,0x33,0x95,0x2f,0x3b,0x23,0x8b,0x31,0x3d,0x39,0x89,0x1e,0x12,0x8c,0x2f,0x3b,0x23,0x89,0x31,0x3d,0x22,0x8b,0x3f,0x33,0x15,0x89,0x40,0x38,0x34,0x95,0x3b,0x2f,0x38,0x8b,0x3d,0x31,0x38,0x8a,0x1c,0x28,0x95,0x23,0x28,0x2c,0x95,0x38,0x34,0x40,0x95,0x3b,0x38,0x2f,0x8b,0x31,0x3d,0x38,0x89,0x1c,0x28,0x95,0x29,0x1d,0x95,0x2a,0x1e,0x95,0x3d,0x27,0x23,0x8b,0x39,0x3b,0x33,0x89,0x17,0x23,0x95,0x2d,0x27,0x23,0x95,0x1e,0x2a,0x95,0x3d,0x27,0x23,0x8b,0x33,0x39,0x3b,0x8a,0x23,0x17,0x94,0x2d,0x23,0x27,0x95,0x1c,0x28,0x95,0x3d,0x2c,0x28,0x8b,0x34,0x3b,0x38,0x89,0x17,0x23,0x95,0x2c,0x28,0x23,0x95,0x1c,0x28,0x94,0x3d,0x23,0x2c,0x8b,0x38,0x34,0x3b,0x8a,0x2c,0x20,0x8b,0x2f,0x3b,0x89,0x31,0x3d,0x1f,0x8b,0x32,0x3e,0x8a,0x3f,0x39,0x33,0x94,0x3b,0x2f,0x2d,0x8b,0x31,0x39,0x3d,0x8a,0x23,0x17,0x95,0x2d,0x27,0x23,0x95,0x39,0x3f,0x33,0x95,0x3b,0x2f,0x27,0x8b,0x31,0x39,0x3d,0x89,0x12,0x1e,0x8b,0x3b,0x2f,0x17,0x8a,0x31,0x3d,0x22,0x8b,0x33,0x3f,0x15,0x89,0x34,0x40,0x38,0x95,0x3b,0x38,0x2f,0x8b,0x3d,0x31,0x38,0x8a,0x28,0x1c,0x95,0x28,0x23,0x2c,0x95,0x20,0x2c,0x8b,0x34,0x89,0x38,0x1c,0x28,0x8b,0x3b,0x8a,0x38,0x40,0x23,0x8b,0x3d,0x8a,0x3b,0x32,0x20,0x8b,0x38,0x89,0x31,0x15,0x21,0x8b,0x39,0x8a,0x19,0x25,0x8b,0x36,0x8a,0x30,0x1e,0x2a,0x8b,0x39,0x89,0x2d,0x21,0x8b,0x36,0x8a,0x20,0x2c,0x8b,0x2f,0x8a,0x34,0x28,0x1c,0x8a,0x38,0x8a,0x3d,0x23,0x17,0x8b,0x3b,0x8a,0x38,0x28,0x1c,0x8b,0x2f,0x89,0x2e,0x25,0x19,0x8c,0x31,0x34,0x89,0x1e,0x12,0x95,0x2d,0x17,0x0b,0x8c,0x33,0x36,0x95,0x34,0x2c,0x8a,0x1c,0x10,0x95,0x17,0x96,0x40,0x34,0x3b,0xff
};





const unsigned char metasprite[]={
        0,      0,      TILE+0,   ATTR, 
        0,      8,      TILE+1,   ATTR, 
        8,      0,      TILE+2,   ATTR, 
        8,      8,      TILE+3,   ATTR, 
        128};
// main function, run after console reset
void main(void) {
  unsigned char apu_state = 0;
  
  // set palette colors
  unsigned int turn = 49;
  unsigned int x = 15;
  unsigned int t = 0;
  signed int cur_x = 64;
  signed int cur_y = 64;
  signed int last_x = 64;
  signed int last_y = 64;
  unsigned int limit_x = 240;
  bool scrolled = false;
  char pad;
  bool left = true;
  bool moved_x = false;
  bool moved_y = false;
  bool p_phase = true;
  bool p_phase_controller = false;
  bool p_attack = false;
  //player char info
  unsigned int p_hp = 20;
  unsigned int p_atk = 10;
  unsigned int p_hit = 95;
  unsigned int p_def = 2;
  unsigned int p_crit = 5;
  signed int p_x = 16;
  signed int p_y = 128;
  bool p_locked = false;
  bool switcher = true;
  
  //enemy info
  unsigned int e_hp = 10;
  unsigned int e_atk = 6;
  unsigned int e_hit = 75;
  unsigned int e_def = 0;
  unsigned int e_crit = 0;
  unsigned int e_x = 200;
  unsigned int e_y = 56;
  
  
  unsigned int portrait_x = 250;
  unsigned int portrait_y = 250;
  
  pal_col(0,0x1a);	// set screen to dark blue
  pal_col(1,0x0d);	// fuchsia
  pal_col(2,0x2c);	// grey
  pal_col(3,0x2a);	// white
  pal_col(17,0x02);
  pal_col(18,0x16);
  pal_col(19,0x08);
  pal_col(20,0x08);
  
  vram_adr(0x2000);
  vram_unrle(map1);
  vram_adr(0x2400);
  vram_unrle(map2);
  

  // enable PPU rendering (turn on screen)
  ppu_on_all();
  vrambuf_clear();
  set_vram_update(updbuf);
  apu_state |= ENABLE_PULSE1;
  APU_ENABLE(apu_state);
  // infinite loop
  while (1) {
    char cur_oam = 0;
    unsigned int i = 0;
    if (p_phase){
      if (p_phase_controller){
        p_phase = false;
        p_phase_controller = false;
      }
      pad = pad_poll(i);
      for(i = 0; i < 2; i++){
        // move actor[i] left/right
        if (pad&PAD_LEFT && cur_x>8 && !moved_x){ cur_x+=-8; moved_x = true;}
        else if (pad&PAD_RIGHT && cur_x<240 && !moved_x){ moved_x = true; cur_x+=8;}
        else if (pad&PAD_RIGHT && cur_x>=240 && !scrolled && !moved_x){
          scroll(256, 0);
          scrolled = true;
          moved_x = true;
          cur_x = 8;
        }
        else if (pad&PAD_LEFT && cur_x<=8 && scrolled){ 
          scroll(0, 0);
          scrolled = false;
          moved_x = true;
          cur_x = 240;
        }
        else if (!(pad&PAD_LEFT)&&!(pad&&PAD_RIGHT)) moved_x = false;
        //else cur_x=0;
        // move actor[i] up/down
        if (pad&PAD_UP && cur_y>8 && !moved_y){ cur_y+=-8; moved_y = true;}
        else if (pad&PAD_DOWN && cur_y<180 && !moved_y){ moved_y = true; cur_y+=8;}
        else if (!(pad&PAD_UP)&&!(pad&&PAD_DOWN)) moved_y = false;
        //else cur_y=0;
        //cur_oam = oam_spr(cur_x, cur_y, 0x90, 0x0, cur_oam);
      }
      cur_oam = oam_spr(cur_x, cur_y, 0x90, 0x0, cur_oam);
      cur_oam = oam_spr(p_x, p_y, 0xd8, 0x0, cur_oam);
      if (e_hp > 0){
      	cur_oam = oam_spr(e_x, e_y, 0xd9, 0x0, cur_oam);
        
      }
      else if (e_hp <= 0 && switcher){
        scroll(256, 0);
          scrolled = true;
          p_x = 16;
  	  p_y = 128; 
        switcher = false;
        turn = 48;
      
      }
      cur_oam = oam_spr(40,199,turn,0x0,cur_oam);
      cur_oam = oam_meta_spr(portrait_x, portrait_y, cur_oam, metasprite);
      if ((p_x == cur_x) && (p_y == cur_y) || p_locked){
        vrambuf_put(NTADR_A(13,26), "95", 2);
        vrambuf_put(NTADR_A(13,27), "05", 2);
        vrambuf_put(NTADR_A(13,25), "10", 2);
        if(p_hp == 20)
        	vrambuf_put(NTADR_A(6,27), "20", 2);
        else if (p_hp == 14)
          	vrambuf_put(NTADR_A(6,27), "14", 2);
        else if (p_hp == 8)
          	vrambuf_put(NTADR_A(6,27), "8", 2);
        else if (p_hp == 2)
          	vrambuf_put(NTADR_A(6,27), "2", 2);
        portrait_x = 48;
        portrait_y = 199;
        if ((pad&PAD_A) && (!(p_locked)) && (!(p_attack))){
          APU_ENABLE(ENABLE_PULSE0);
          APU_PULSE_DECAY(PULSE_CH0, 250, DUTY_25, 1, 7);
          p_locked = true;
        }
      }
      else{
        vrambuf_put(NTADR_A(13,26), "  ", 2);
        vrambuf_put(NTADR_A(13,27), "  ", 2);
        vrambuf_put(NTADR_A(13,25), "  ", 2);
        vrambuf_put(NTADR_A(6,27), "  ", 2);
        portrait_x = 250;
        portrait_y = 250;
        
      }
      if (p_locked){
          if ((pad&PAD_A) && ((p_x != cur_x)|| (p_y != cur_y))){
            if (((p_x - cur_x) + (p_y - cur_y) >= -16) && ((p_x - cur_x) + (p_y - cur_y) <= 16)){
            last_x = p_x;
            last_y = p_y;
            p_x = cur_x;
            p_y = cur_y;
            p_attack = true;
            p_locked = false;
            }
          }
          else if((pad&PAD_SELECT)){
            p_attack = true;
            p_locked = false;
          }
        cur_oam = oam_spr(p_x +8, p_y, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -8, p_y, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y +8, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y-8, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x +16, p_y, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -16, p_y, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y +16, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y-16, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x +8, p_y +8, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -8, p_y -8, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x - 8, p_y +8, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x + 8, p_y-8, 0x02, 0x0, cur_oam);
        
        }
      else {
        cur_oam = oam_spr(p_x +8, p_y, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -8, p_y, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y +8, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y-8, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x +16, p_y, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -16, p_y, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y +16, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y-16, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x +8, p_y +8, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -8, p_y -8, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x - 8, p_y +8, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x + 8, p_y-8, 0x00, 0x0, cur_oam);
      }
      if (p_attack){
        cur_oam = oam_spr(p_x +8, p_y, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -8, p_y, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y +8, 0x02, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y-8, 0x02, 0x0, cur_oam);
        if (pad&PAD_B){
          p_x = last_x;
          p_y = last_y;
          p_attack = false;
          //p_locked = true;
          APU_ENABLE(ENABLE_PULSE0);
          APU_PULSE_DECAY(PULSE_CH0, 2000, DUTY_25, 5, 13);
        }
        if ((p_x == cur_x) && (p_y == cur_y) && (pad&PAD_START)){
          p_phase_controller = true;
          p_attack = false;
        }
	else if ((cur_x == e_x) && (cur_y == e_y) && (pad&PAD_START)){
	  if (((p_x == e_x + 8) && (p_y == e_y))||((p_x == e_x - 8) && (p_y == e_y))||
              ((p_x == e_x) && (p_y == e_y + 8))||((p_x == e_x) && (p_y == e_y - 8))){
          	e_hp -= p_atk;
	  	p_phase_controller = true;
          	p_attack = false;
          }
        }
        else if (pad&PAD_START){
          APU_ENABLE(ENABLE_PULSE0);
          APU_PULSE_DECAY(PULSE_CH0, 2000, DUTY_25, 5, 13);
        }
      }
      else{
        cur_oam = oam_spr(p_x +8, p_y, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x -8, p_y, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y +8, 0x00, 0x0, cur_oam);
        cur_oam = oam_spr(p_x, p_y-8, 0x00, 0x0, cur_oam);
      }
        
      
      if ((e_x ==  cur_x) && (e_y == cur_y)){
        vrambuf_put(NTADR_A(17,26), "75", 2);
        vrambuf_put(NTADR_A(17,27), "00", 2);
        vrambuf_put(NTADR_A(17,25), "06", 2);
        vrambuf_put(NTADR_A(24,27), "10", 2);
        portrait_x = 192;
        portrait_y = 199;
      }
      else{
        vrambuf_put(NTADR_A(17,26), "  ", 2);
        vrambuf_put(NTADR_A(17,27), "  ", 2);
        vrambuf_put(NTADR_A(17,25), "  ", 2);
        vrambuf_put(NTADR_A(24,27), "  ", 2);
      }
      if ((pad&PAD_B) && p_locked)
        p_locked = false;
    }
    else{
      if ((e_x == p_x + 8 && e_y == p_y) || (e_x == p_x - 8 && e_y == p_y) || (e_x == p_x && e_y == p_y + 8) || (e_x == p_x && e_y == p_y - 8))
        e_x += 0;
      else if(e_x < p_x && e_y < p_y){
        e_x += 8;
        e_y += 8;
      }
      else if(e_x > p_x && e_y < p_y){
        e_x -= 8;
        e_y += 8;
      }
      else if(e_x > p_x && e_y > p_y){
        e_x -= 8;
        e_y -= 8;
      }
      else if(e_x < p_x && e_y > p_y){
        e_x += 8;
        e_y -= 8;
      }
      else if(e_x == p_x && e_y > p_y){
        e_y -= 16;
      }
      else if(e_x < p_x && e_y == p_y){
        e_x += 16;
      }
      else if(e_x == p_x && e_y < p_y){
        e_y += 16;
      }
      else if(e_x > p_x && e_y == p_y){
        e_x -= 16;
      }
      if(e_x == p_x && e_y == p_y){
        e_x += 8;
      }
      if((e_x == p_x + 8 && e_y == p_y) || (e_x == p_x - 8 && e_y == p_y) || (e_x == p_x && e_y == p_y + 8) || (e_x == p_x && e_y == p_y - 8)){
        p_hp -= 6;
      }
      p_phase = true;
      turn += 1;
    }
    play_music();
    vrambuf_flush();
  }
}
